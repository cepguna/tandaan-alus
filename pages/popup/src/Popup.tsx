import { useStorage, withErrorBoundary, withSuspense } from '@extension/shared';
import { exampleThemeStorage, refreshTokenStorage, tokenStorage } from '@extension/storage';
import { t } from '@extension/i18n';
import { ToggleButton } from '@extension/ui';
import { Login } from './Login';
import { Authenticated, Unauthenticated, AuthLoading } from 'convex/react';
import { User } from './User';
import { useEffect } from 'react';
import { useAuthToken } from '@convex-dev/auth/react';

const Popup = () => {
  const x = useAuthToken();
  console.log(x);
  const theme = useStorage(exampleThemeStorage);
  const token = useStorage(tokenStorage);
  const refreshToken = useStorage(refreshTokenStorage);
  const isLight = theme === 'light';

  const goToWebsite = () => chrome.tabs.create({ url: 'http://localhost:3000' });

  useEffect(() => {
    console.log('token popup', token);
    console.log('theme popup', theme);
    console.log('refreshToken popup', refreshToken);
    if (token) {
      localStorage.setItem('__convexAuthJWT_httpskeenpika344convexcloud', token);
    } else {
      localStorage.removeItem('__convexAuthJWT_httpskeenpika344convexcloud');
    }
    if (refreshToken) {
      localStorage.setItem('__convexAuthRefreshToken_httpskeenpika344convexcloud', refreshToken);
    } else {
      localStorage.removeItem('__convexAuthRefreshToken_httpskeenpika344convexcloud');
    }
  }, [token, theme, refreshToken]);

  return (
    <div
      className={`absolute top-0 right-0 bottom-0 left-0 h-full p-4 ${isLight ? 'bg-slate-50 text-gray-900' : 'bg-gray-800 text-white'}`}>
      <AuthLoading>
        <div className="text-center flex items-center justify-center h-full">
          <span className="text-xl font-bold animate-pulse">Loading...</span>
        </div>
      </AuthLoading>
      <Unauthenticated>
        <Login />
      </Unauthenticated>
      <Authenticated>
        <User />
      </Authenticated>
      <div className="absolute top-2 right-2">
        <ToggleButton />
      </div>
      <div className="absolute left-0 bottom-2 flex items-center justify-center w-full">
        <svg
          onClick={goToWebsite}
          data-logo="logo"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 270 43"
          width="154"
          height="42">
          <g id="logogram" transform="translate(0, 1) rotate(0)">
            <path
              fill-rule="evenodd"
              clip-rule="evenodd"
              fill={isLight ? '#1f2937' : '#ffffff'}
              d="M10 5C8.89543 5 8 5.89543 8 7V35C8 36.1046 8.89543 37 10 37H26C27.1046 37 28 36.1046 28 35V15L18 25L10 17V7C10 5.89543 10.8954 5 12 5H10Z"
            />
          </g>
          <g id="logotype" transform="translate(43, 5.5)">
            <path
              fill={isLight ? '#1f2937' : '#ffffff'}
              d="M19.93 29L14.44 29L14.44 4.64L19.93 4.64L19.93 29ZM27.67 9.08L6.70 9.08L6.70 4.29L27.67 4.29L27.67 9.08ZM32.60 29.35L32.60 29.35Q30.26 29.35 28.42 28.20Q26.58 27.04 25.51 25.04Q24.45 23.05 24.45 20.49L24.45 20.49Q24.45 17.94 25.51 15.94Q26.58 13.95 28.42 12.79Q30.26 11.64 32.60 11.64L32.60 11.64Q34.31 11.64 35.70 12.30Q37.08 12.97 37.95 14.14Q38.83 15.31 38.94 16.82L38.94 16.82L38.94 24.17Q38.83 25.68 37.97 26.85Q37.12 28.02 35.72 28.68Q34.31 29.35 32.60 29.35ZM33.69 24.52L33.69 24.52Q35.40 24.52 36.45 23.38Q37.50 22.24 37.50 20.49L37.50 20.49Q37.50 19.30 37.03 18.39Q36.55 17.48 35.70 16.98Q34.84 16.47 33.72 16.47L33.72 16.47Q32.60 16.47 31.74 16.98Q30.89 17.48 30.38 18.39Q29.87 19.30 29.87 20.49L29.87 20.49Q29.87 21.65 30.36 22.56Q30.85 23.47 31.73 23.99Q32.60 24.52 33.69 24.52ZM42.54 29L37.29 29L37.29 24.41L38.09 20.28L37.29 16.16L37.29 11.99L42.54 11.99L42.54 29ZM62.21 29L56.86 29L56.86 19.30Q56.86 17.98 56.03 17.15Q55.21 16.33 53.95 16.33L53.95 16.33Q53.08 16.33 52.41 16.70Q51.75 17.06 51.36 17.75Q50.98 18.43 50.98 19.30L50.98 19.30L48.91 18.29Q48.91 16.29 49.79 14.79Q50.66 13.28 52.22 12.46Q53.78 11.64 55.74 11.64L55.74 11.64Q57.63 11.64 59.08 12.53Q60.53 13.42 61.37 14.89Q62.21 16.36 62.21 18.11L62.21 18.11L62.21 29ZM50.98 29L45.62 29L45.62 11.99L50.98 11.99L50.98 29ZM72.19 29.35L72.19 29.35Q69.77 29.35 67.90 28.20Q66.03 27.04 64.96 25.04Q63.89 23.05 63.89 20.49L63.89 20.49Q63.89 17.94 64.96 15.94Q66.03 13.95 67.90 12.79Q69.77 11.64 72.19 11.64L72.19 11.64Q73.94 11.64 75.35 12.30Q76.77 12.97 77.70 14.14Q78.63 15.31 78.73 16.82L78.73 16.82L78.73 23.99Q78.63 25.50 77.72 26.71Q76.81 27.91 75.37 28.63Q73.94 29.35 72.19 29.35ZM73.13 24.52L73.13 24.52Q74.29 24.52 75.13 24.01Q75.97 23.50 76.46 22.59Q76.95 21.68 76.95 20.49L76.95 20.49Q76.95 19.30 76.47 18.41Q76 17.52 75.14 16.99Q74.29 16.47 73.17 16.47L73.17 16.47Q72.05 16.47 71.19 16.99Q70.33 17.52 69.82 18.43Q69.31 19.34 69.31 20.49L69.31 20.49Q69.31 21.65 69.81 22.56Q70.30 23.47 71.17 23.99Q72.05 24.52 73.13 24.52ZM81.99 3.59L81.99 29L76.73 29L76.73 24.41L77.54 20.28L76.63 16.16L76.63 3.59L81.99 3.59ZM92.17 29.35L92.17 29.35Q89.83 29.35 87.99 28.20Q86.15 27.04 85.08 25.04Q84.02 23.05 84.02 20.49L84.02 20.49Q84.02 17.94 85.08 15.94Q86.15 13.95 87.99 12.79Q89.83 11.64 92.17 11.64L92.17 11.64Q93.88 11.64 95.27 12.30Q96.65 12.97 97.53 14.14Q98.40 15.31 98.50 16.82L98.50 16.82L98.50 24.17Q98.40 25.68 97.54 26.85Q96.69 28.02 95.28 28.68Q93.88 29.35 92.17 29.35ZM93.25 24.52L93.25 24.52Q94.97 24.52 96.02 23.38Q97.07 22.24 97.07 20.49L97.07 20.49Q97.07 19.30 96.60 18.39Q96.13 17.48 95.27 16.98Q94.41 16.47 93.29 16.47L93.29 16.47Q92.17 16.47 91.31 16.98Q90.45 17.48 89.95 18.39Q89.44 19.30 89.44 20.49L89.44 20.49Q89.44 21.65 89.93 22.56Q90.42 23.47 91.30 23.99Q92.17 24.52 93.25 24.52ZM102.11 29L96.86 29L96.86 24.41L97.66 20.28L96.86 16.16L96.86 11.99L102.11 11.99L102.11 29ZM112.30 29.35L112.30 29.35Q109.95 29.35 108.11 28.20Q106.27 27.04 105.21 25.04Q104.14 23.05 104.14 20.49L104.14 20.49Q104.14 17.94 105.21 15.94Q106.27 13.95 108.11 12.79Q109.95 11.64 112.30 11.64L112.30 11.64Q114.01 11.64 115.39 12.30Q116.78 12.97 117.65 14.14Q118.53 15.31 118.63 16.82L118.63 16.82L118.63 24.17Q118.53 25.68 117.67 26.85Q116.81 28.02 115.41 28.68Q114.01 29.35 112.30 29.35ZM113.38 24.52L113.38 24.52Q115.09 24.52 116.14 23.38Q117.19 22.24 117.19 20.49L117.19 20.49Q117.19 19.30 116.72 18.39Q116.25 17.48 115.39 16.98Q114.53 16.47 113.41 16.47L113.41 16.47Q112.30 16.47 111.44 16.98Q110.58 17.48 110.07 18.39Q109.56 19.30 109.56 20.49L109.56 20.49Q109.56 21.65 110.05 22.56Q110.55 23.47 111.42 23.99Q112.30 24.52 113.38 24.52ZM122.23 29L116.98 29L116.98 24.41L117.79 20.28L116.98 16.16L116.98 11.99L122.23 11.99L122.23 29ZM141.91 29L136.55 29L136.55 19.30Q136.55 17.98 135.73 17.15Q134.91 16.33 133.65 16.33L133.65 16.33Q132.77 16.33 132.10 16.70Q131.44 17.06 131.06 17.75Q130.67 18.43 130.67 19.30L130.67 19.30L128.60 18.29Q128.60 16.29 129.48 14.79Q130.35 13.28 131.91 12.46Q133.47 11.64 135.43 11.64L135.43 11.64Q137.32 11.64 138.77 12.53Q140.22 13.42 141.06 14.89Q141.91 16.36 141.91 18.11L141.91 18.11L141.91 29ZM130.67 29L125.31 29L125.31 11.99L130.67 11.99L130.67 29ZM149.33 32.36L145.02 32.36L145.02 3.59L149.33 3.59L149.33 32.36ZM153.84 32.36L147.16 32.36L147.16 28.44L153.84 28.44L153.84 32.36ZM153.84 7.51L147.16 7.51L147.16 3.59L153.84 3.59L153.84 7.51ZM163.26 29.35L163.26 29.35Q160.91 29.35 159.07 28.20Q157.24 27.04 156.17 25.04Q155.10 23.05 155.10 20.49L155.10 20.49Q155.10 17.94 156.17 15.94Q157.24 13.95 159.07 12.79Q160.91 11.64 163.26 11.64L163.26 11.64Q164.97 11.64 166.35 12.30Q167.74 12.97 168.61 14.14Q169.49 15.31 169.59 16.82L169.59 16.82L169.59 24.17Q169.49 25.68 168.63 26.85Q167.77 28.02 166.37 28.68Q164.97 29.35 163.26 29.35ZM164.34 24.52L164.34 24.52Q166.06 24.52 167.11 23.38Q168.16 22.24 168.16 20.49L168.16 20.49Q168.16 19.30 167.68 18.39Q167.21 17.48 166.35 16.98Q165.50 16.47 164.38 16.47L164.38 16.47Q163.26 16.47 162.40 16.98Q161.54 17.48 161.03 18.39Q160.53 19.30 160.53 20.49L160.53 20.49Q160.53 21.65 161.02 22.56Q161.51 23.47 162.38 23.99Q163.26 24.52 164.34 24.52ZM173.20 29L167.95 29L167.95 24.41L168.75 20.28L167.95 16.16L167.95 11.99L173.20 11.99L173.20 29ZM181.63 29L176.28 29L176.28 3.59L181.63 3.59L181.63 29ZM192.27 29.39L192.27 29.39Q189.93 29.39 188.12 28.42Q186.32 27.46 185.31 25.76Q184.29 24.06 184.29 21.86L184.29 21.86L184.29 11.99L189.65 11.99L189.65 21.79Q189.65 22.66 189.94 23.29Q190.24 23.93 190.84 24.27Q191.43 24.63 192.27 24.63L192.27 24.63Q193.46 24.63 194.16 23.87Q194.86 23.12 194.86 21.79L194.86 21.79L194.86 11.99L200.22 11.99L200.22 21.82Q200.22 24.06 199.20 25.76Q198.19 27.46 196.40 28.42Q194.62 29.39 192.27 29.39ZM209.07 29.42L209.07 29.42Q207.57 29.42 206.11 29.04Q204.66 28.65 203.42 27.93Q202.18 27.21 201.30 26.27L201.30 26.27L204.35 23.19Q205.19 24.10 206.34 24.61Q207.50 25.11 208.86 25.11L208.86 25.11Q209.81 25.11 210.31 24.84Q210.82 24.55 210.82 24.06L210.82 24.06Q210.82 23.43 210.21 23.10Q209.60 22.77 208.65 22.51Q207.71 22.24 206.66 21.93Q205.61 21.61 204.66 21.05Q203.72 20.49 203.12 19.50Q202.53 18.50 202.53 16.96L202.53 16.96Q202.53 15.31 203.37 14.11Q204.21 12.90 205.75 12.20Q207.29 11.50 209.35 11.50L209.35 11.50Q211.52 11.50 213.36 12.25Q215.20 13.00 216.35 14.47L216.35 14.47L213.31 17.55Q212.50 16.61 211.50 16.23Q210.51 15.84 209.56 15.84L209.56 15.84Q208.65 15.84 208.20 16.10Q207.74 16.36 207.74 16.85L207.74 16.85Q207.74 17.38 208.34 17.70Q208.93 18.01 209.88 18.25Q210.82 18.50 211.87 18.85Q212.92 19.20 213.87 19.80Q214.81 20.39 215.41 21.39Q216.00 22.38 216.00 23.99L216.00 23.99Q216.00 26.48 214.13 27.95Q212.26 29.42 209.07 29.42ZM226.26 32.36L221.95 32.36L221.95 3.59L226.26 3.59L226.26 32.36ZM224.12 32.36L217.44 32.36L217.44 28.44L224.12 28.44L224.12 32.36ZM224.12 7.51L217.44 7.51L217.44 3.59L224.12 3.59L224.12 7.51Z"
            />
          </g>
        </svg>
      </div>
    </div>
  );
};

export default withErrorBoundary(withSuspense(Popup, <div> Loading ... </div>), <div> Error Occur </div>);
